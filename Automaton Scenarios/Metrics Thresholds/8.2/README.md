# Базовые примеры сценариев

> [!WARNING]
> ВСЕ ПРЕДСТАВЛЕННЫЕ СЦЕНАРИИ ЯВЛЯЮТСЯ ТОЛЬКО ПРИМЕРАМИ РЕАЛИЗАЦИИ СЦЕНАРИЕВ АВТОМАТИЗАЦИИ! 
>
> Их можно и нужно дорабатывать под свои потребности. 

> [!NOTE]
> Все сценарии после импорта и первоначальной настройки необходимо **Скомпилировать** и **Активировать**.

## Содержание

- [Сценарий привязки Порогов метрик к КЕ](#сценарий-привязки-порогов-метрик-к-ке)
- [Сценарий создания Сигналов на основе срабатывания Порогов по метрикам](#сценарий-создания-сигналов-на-основе-результатов-автотестов)

## Сценарий привязки Порогов метрик к КЕ

[**Bind Thresholds to CIs.txt**](./Bind%20Thresholds%20to%20CIs.txt)

Тип сценария: `ThresholdsProcessor`

Сценарий предназначен для привязки Порогов метрик к Конфигурационным Единицам.
Главным принципом для привязки любых объектов в Monq является корреляция некоторых параметров этих объектов. В данном демонстрационном сценарии для корреляции Порогов и КЕ сравниваются метки метрик и кастомные атрибуты КЕ и при их совпадении выполняется привязке.

Какие настройки в Monq необходимо выполнить, чтобы заработал этот сценарий:
1. в настройках CMDB выбрать Тип КЕ (или создать новый), в рамках которого планируется привязывать Пороги
2. в секции **Атрибуты КЕ** добавить новый Атрибут (точно соблюдайте написание значений, они используются в сценарии!):
    - Название: `commonPropertyAttr`
    - Тип: `Dynamic`
    - Значение по-умолчанию: `{ "commonPropertyKey": ""}`
3. в параметрах каждой КЕ этого типа появится этот атрибут. Его нужно заполнить (вручную или автоматически) уникальным значением, совпадающим с уникальным значением в метках метрики в следующем формате:
`{ "commonPropertyKey": "уникальное значение"}`
<img src="./img/01.png" width="600">
скрины свойств КЕ

ВНИМАНИЕ. Реализованный в этом сценарии принцип привязки - ДЕМОНСТРАЦИОННЫЙ. Главная идея: в свойствах КЕ и Порогах метрик должно быть что-то общее, признак, по которому в сценарии будет выполняться корреляция. В даном примере это аттрибут КЕ `commonPropertyAttr` с заполненным ключом `commonPropertyKey`, который в сценарии сравнивается с меткой `pod` метрики, помещенной в аннотацию `bindci`.

Для указания Слота надо:
1. в настройках CMDB выбрать Тип КЕ (или создать новый), в рамках которого КЕ этого типа планируется привязывать к Порогам
2. выбрать (или создать новый) компонент, у которого должны быть Слоты
3. добавить Слоты (ссылка на инструкцию)
4. в Правилах Порогов добавить в аннотации новое поле с именем `slot` и указать один из Слотов, созданных в п.3

## Сценарий создания Сигналов на основе срабатывания Порогов по метрикам

[**Signal Processor from Thresholds.txt**](./Signal Processor from Thresholds.txt)

Тип сценария: `SignalProcessor`

> [!IMPORTANT]
> Даже если привязка Сигналов и Порогов к КЕ не планируется, для работы сигнального сценария требуется наличие активированного [**Сценария привязки Порогов метрик к КЕ**](#сценарий-привязки-порогов-метрик-к-ке), т.к. именно в него первоначально поступают события по порогам и выполняется переадресация в сигнальный сценарий.

Этот сценарий обрабатывает изменяющиеся пороговые значения метрик и на основе установленной критичности Порогов, создает, подтверждает или закрывает Сигналы.

Если сценарий привязки Порогов метрик к КЕ не был настроен и у Порогов нет привязанных к ним КЕ, то Сигналы по этим Порогам также будут создаваться без привязки к КЕ.

В качестве дополнительной информации к Сигналу может быть добавлена ссылка на Порог, приведший к открытию Сигнала. Чтобы это произошло, необходимо заполнить локальную переменную _FQDN доменным именем инсталляции Monq в формате `monq.domain.ru`

Если сценарий должен работать только с определенными Правилами Порогов, их id нужно указать в настройках функции `FilterStruct` и отключить передачу управления по пину *False*. Если оба пина *True* и *False* оставить подключенными, сценарий будет срабатывать по всем Правилам Порогов в пределах Рабочей группы.

В импортированном сценарии необходимо указать ID Правил порогов в переменной RuleIds  
<img src="./img/06.png" width="600">

<img src="./img/01.png" width="600">
